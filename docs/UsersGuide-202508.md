# GSImap 利用者の手引（2025年8月版）

## はじめに

GSImapは、国土地理院の地形図をベースとした地図アプリケーションです。PNG画像のオーバーレイ表示、GPSデータの可視化、ポイント・ルートデータの管理など、地理空間データを効率的に扱える機能を提供します。

### 主な用途
- 古い地図や計画図面を現在の地形図と比較
- Excel形式のGPS調査データの地図上での可視化
- 既存のポイント・ルートデータの確認と管理
- GeoJSONデータの地図表示

## アプリケーションの起動

### 1. 推奨環境
- **ブラウザ**: Chrome、Firefox、Edge、Safari（最新版推奨）
- **画面解像度**: 1024×768以上
- **インターネット接続**: 地図タイルの取得に必要

### 2. アプリケーションの開始
1. Webブラウザでindex.htmlファイルを開く
2. ローカルサーバー使用時: `python -m http.server`等でサーバーを起動
3. 地図が表示されたら準備完了

## 基本操作ガイド

### 地図操作
- **移動**: 地図をドラッグして任意の場所に移動
- **拡大/縮小**: マウスホイールまたは地図コントロールで縮尺変更
- **初期位置**: 箕面大滝周辺（大阪府）が初期表示位置

### コントロールパネル
- **位置**: 画面右上のフローティングパネル
- **背景**: 半透明背景でブラーエフェクト適用
- **サイズ**: レスポンシブ対応（240-300px幅）

## 編集モード

### モード切り替え
コントロールパネル上部のラジオボタンで編集モードを選択：

#### 🖼️ 画像・GPS編集モード（デフォルト）
PNG画像のオーバーレイ、GPSデータ表示、GeoJSON読み込みが可能

#### 📍 ポイント・ルート編集モード
既存のポイント・ルートJSONファイルの読み込み・表示が可能

## 画像・GPS編集モードの使い方

### 1. PNG画像オーバーレイ

#### 画像の読み込み
1. **「画像(PNG)読込」ボタン**をクリック
2. PNG形式の画像ファイルを選択
3. 画像が地図上に表示される

#### 画像の調整
- **表示倍率**: 数値入力で画像サイズを調整（0.1～、初期値0.3）
- **透過度**: スライダーで透明度を調整（0-100%、初期値50%）
- **中心座標**: 画像の配置位置を数値で確認（読み取り専用）

#### インタラクティブ編集
- **中心マーカー**: 赤い中心点をドラッグして画像を移動
- **リサイズハンドル**: 四隅の赤いハンドルで画像サイズ調整
- **座標設定**: 「中心座標」ボタンで座標設定モード切り替え

### 2. GPSデータ表示

#### Excelファイルの準備
GPS データは以下の形式のExcel(.xlsx)ファイルで準備：

**必須列**:
| 列名 | データ型 | 説明 | 例 |
|------|----------|------|-----|
| 緊急ポイント | 文字列 | ポイント識別子 | "P001" |
| 緯度 | 数値 | 10進数緯度 | 34.853667 |
| 経度 | 数値 | 10進数経度 | 135.472041 |

**オプション列**:
| 列名 | データ型 | 説明 | 例 |
|------|----------|------|-----|
| 位置 または 場所 | 文字列 | 場所名 | "箕面大滝" |
| 標高 | 数値 | 標高(m) | 285.5 |

**重要**: 座標は10進数形式で入力してください（度分秒形式は非対応）。

#### GPSデータの読み込み
1. **「GPS値(Excel)読込」ボタン**をクリック
2. .xlsxファイルを選択
3. ダークグリーンの逆三角形マーカーが地図上に表示
4. マーカークリックでポイント情報（ID、座標、標高、場所）をポップアップ表示
5. 自動的に全ポイントが表示されるよう地図範囲が調整される

### 3. GeoJSONデータ

#### ファイル読み込み
1. **「GeoJSON読込」ボタン**をクリック
2. .geojsonまたは.jsonファイルを選択
3. 地理的フィーチャーが地図上に表示

#### 表示スタイル
- **ポイント**: オレンジ色円形マーカー
- **ライン/ポリゴン**: オレンジ色（#ff7800）、線幅3px
- **プロパティ**: name属性がある場合ポップアップ表示

## ポイント・ルート編集モードの使い方

### 1. ポイントJSONファイル読み込み

#### ファイル形式
PickPointsアプリ等で出力されたポイントJSONファイル：
```json
{
  "totalPoints": 5,
  "imageInfo": {"width": 1920, "height": 1080},
  "points": [
    {"index": 1, "id": "A001", "x": 640, "y": 480, "isMarker": false}
  ]
}
```

#### 読み込み手順
1. **「ポイントJSON読込」ボタン**をクリック
2. ポイントJSONファイルを選択
3. 赤色円形マーカーが地図上に表示
4. マーカークリックでポイントID表示

### 2. ルートJSONファイル読み込み

#### ファイル形式
PickPointsアプリ等で出力されたルートJSONファイル：
```json
{
  "routeInfo": {"startPoint": "START", "endPoint": "GOAL", "waypointCount": 5},
  "imageInfo": {"width": 1920, "height": 1080},
  "points": [
    {"type": "waypoint", "index": 1, "x": 320, "y": 240}
  ]
}
```

#### 読み込み手順
1. **「ルートJSON読込」ボタン**をクリック  
2. ルートJSONファイルを選択
3. 青色円形マーカーが中間点として表示
4. 中間点を結ぶ青色ラインが描画

## 操作のコツとヒント

### 画像オーバーレイ調整
1. **初期サイズ設定**: 表示倍率0.1-0.5程度から開始
2. **透過度調整**: 地図との見比べには30-70%が適切
3. **精密調整**: ドラッグハンドル使用でピクセル単位の調整可能

### データファイル準備
1. **GPS座標**: 10進数形式で準備（例: 34.853667, 135.472041）
2. **画像形式**: PNG形式のみ対応（JPEG等は非対応）
3. **文字エンコード**: JSONファイルはUTF-8で保存
4. **Excel列名**: ヘッダー行に「緊急ポイント」「緯度」「経度」の正確な列名を記載

### 表示順序とレイヤー管理
- 画像オーバーレイ → GPSマーカー → GeoJSONデータ の順で表示
- 新しいファイル読み込み時は既存データに追加表示
- ページ再読み込みで全データクリア

## トラブルシューティング

### よくある問題と解決方法

#### ファイル読み込みエラー
**問題**: 「ファイルの読み込みに失敗しました」
**解決方法**:
- ファイル形式を確認（PNG、xlsx、JSON）
- ファイルが破損していないか確認
- ブラウザキャッシュをクリア

#### 画像が表示されない
**問題**: PNG画像が地図上に表示されない
**解決方法**:
- PNG形式であることを確認
- 画像サイズが適切か確認（数MB以下推奨）
- 表示倍率を0.1-1.0の範囲で調整

#### 座標変換エラー  
**問題**: GPS座標の解析に失敗
**解決方法**:
- 座標が10進数形式であることを確認（例: 34.853667）
- 列名が正確であることを確認（「緊急ポイント」「緯度」「経度」）
- データに空白行や不正な値が含まれていないか確認

#### レスポンシブ表示の問題
**問題**: 小さな画面でコントロールが見えない
**解決方法**:
- ブラウザズーム設定を75-100%に調整
- 横画面での利用を推奨
- 最小解像度1024×768以上での利用

### エラーメッセージ対応

#### 「ES6 Modulesに対応していません」
- モダンブラウザ（Chrome 90+、Firefox 88+等）を使用
- ローカルサーバー経由でアプリケーション実行

#### 「座標値が無効です」
- GPS座標が10進数形式であることを確認
- 有効な数値範囲内であることを確認（緯度: -90～90, 経度: -180～180）

#### 「JSONファイルが無効です」
- ファイルがJSON形式であることを確認
- 必要なプロパティ（points、imageInfo等）の存在確認

## データ形式リファレンス

### GPSデータ（Excel形式）
**必須列**:
```
緊急ポイント列: ポイントID（文字列）例: "P001"
緯度列: 10進数緯度（数値）例: 34.853667
経度列: 10進数経度（数値）例: 135.472041
```

**オプション列**:
```
位置または場所列: 場所名（文字列）例: "箕面大滝"
標高列: 標高値（数値）例: 285.5
```

### ポイントJSONデータ
```json
{
  "totalPoints": 数値,
  "imageInfo": {"width": 数値, "height": 数値},
  "points": [
    {
      "index": 数値,
      "id": "文字列",
      "x": 数値,
      "y": 数値,
      "isMarker": 真偽値
    }
  ],
  "exportedAt": "ISO8601日時文字列"
}
```

### ルートJSONデータ
```json
{
  "routeInfo": {
    "startPoint": "文字列",
    "endPoint": "文字列",
    "waypointCount": 数値
  },
  "imageInfo": {"width": 数値, "height": 数値},
  "points": [
    {
      "type": "waypoint",
      "index": 数値,
      "x": 数値,
      "y": 数値
    }
  ],
  "exportedAt": "ISO8601日時文字列"
}
```

## 更新履歴

### バージョン2.0（2025年8月）
- モジュール化アーキテクチャに移行
- 編集モード切り替え機能を追加
- オーバーレイレイアウトに変更
- ポイント・ルート編集機能を追加
- エラーハンドリングの改善

### バージョン1.x
- 基本的な画像オーバーレイ機能
- GPSデータ表示機能
- GeoJSON読み込み機能

---

**発行日**: 2025年8月11日  
**対象バージョン**: GSImap v2.1  
**作成者**: Claude Code

## 付録

### キーボードショートカット
- なし（マウス操作中心の設計）

### 推奨ワークフロー
1. 地図を目的地域に移動・拡大
2. 編集モードを選択
3. ファイルを読み込み
4. 画像・データの位置・表示を調整
5. 必要に応じて複数ファイルを追加読み込み

### サポート・問い合わせ
技術的な問題については、ブラウザの開発者ツール（F12キー）でコンソールエラーを確認し、問題解決の参考にしてください。