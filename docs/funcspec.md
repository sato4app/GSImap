# GSImapアプリケーション 機能仕様書

## 概要

GSImapは、国土地理院（GSI）の地形図上にPNG画像のオーバーレイ表示、GPS座標データの可視化、GeoJSONデータの読み込み機能を提供するWebベースの地理空間画像オーバーレイツールです。

## システム構成

### 技術スタック
- **フロントエンド**: Vanilla JavaScript (ES6+)
- **地図ライブラリ**: Leaflet.js v1.9.4
- **ファイル処理**: SheetJS (XLSX) v0.18.5
- **地図データ**: 国土地理院タイルサーバー
- **ブラウザAPI**: FileReader API、DOM API

### アーキテクチャ
- **実装方式**: シングルページアプリケーション（SPA）
- **ビルドシステム**: 不要（直接HTML/CSS/JavaScript実行）
- **状態管理**: グローバル変数による状態管理

## 主要機能

### 1. 地図表示機能

#### 1.1 基本地図表示
- **機能**: 国土地理院の地形図を基本地図として表示
- **初期表示位置**: 箕面大滝周辺（北緯34.853667度、東経135.472041度）
- **初期ズームレベル**: 15
- **スケールバー**: 右下に表示（メートル法のみ）

#### 1.2 地図操作
- **パン**: ドラッグによる地図移動
- **ズーム**: マウスホイールまたはズームコントロール
- **中心座標設定**: 専用ボタンでクリック位置を新しい中心に設定

### 2. 画像オーバーレイ機能

#### 2.1 PNG画像読み込み
- **対応フォーマット**: PNG形式のみ
- **読み込み方法**: ファイル選択ダイアログ
- **表示方式**: Leaflet ImageOverlayレイヤーとして表示
- **エラーハンドリング**: 無効ファイル・破損ファイルの検出と通知

#### 2.2 画像表示制御
- **表示倍率調整**
  - 数値入力による倍率設定（0.1以上、0.1刻み）
  - デフォルト値: 0.3
  - 画面幅に対する比率で指定
  
- **透過度制御**
  - スライダーによる透過度調整（0-100%）
  - デフォルト値: 50%
  - リアルタイム更新

#### 2.3 画像位置・サイズ調整
- **中心座標設定**
  - 赤い円形マーカーによる中心位置表示
  - ドラッグによる画像全体の移動
  - 座標値のリアルタイム表示（北緯・東経）

- **サイズ調整**
  - 四隅に赤い円形ハンドル配置
  - アスペクト比保持リサイズ
  - 対角線ベースのスケーリング
  - 最小サイズ制限（0.001度）
  - リサイズ中の倍率表示

#### 2.4 インタラクション制御
- **ドラッグ状態管理**
  - 画像移動中の地図パン無効化
  - リサイズ中の地図パン無効化
  - カーソル変更（移動時: move、リサイズ時: nw-resize等）

- **ツールチップ表示**
  - ハンドルホバー時の操作説明
  - リサイズ中の倍率情報表示

### 3. GPS座標データ機能

#### 3.1 Excelファイル読み込み
- **対応フォーマット**: Microsoft Excel (.xlsx)
- **必須列**
  - `緊急ポイント`: マーカーID（空白の場合は非表示）
  - `緯度`: 緯度座標（10進数形式）
  - `経度`: 経度座標（10進数形式）
- **オプション列**
  - `地点`/`場所`/`位置`: 場所名（マーカー名に追加）

#### 3.2 マーカー表示
- **マーカー形状**: 逆二等辺三角形
- **マーカー色**: 青色（#4444FF）
- **マーカーサイズ**: 幅12px、高さ16px
- **位置精度**: 三角形の先端をGPS座標に配置
- **視覚効果**: ドロップシャドウ付き

#### 3.3 情報表示
- **ポップアップ**: クリックで緊急ポイント名＋場所名表示
- **データ検証**: 無効座標・空白データの自動スキップ
- **処理結果**: コンソールログで作成マーカー数表示

### 4. GeoJSONデータ機能

#### 4.1 ファイル読み込み
- **対応フォーマット**: GeoJSON (.geojson, .json)
- **読み込み方法**: ファイル選択ダイアログ
- **エラーハンドリング**: JSON解析エラーの検出と通知

#### 4.2 地理フィーチャー表示
- **線・面フィーチャー**
  - 線色: オレンジ (#ff7800)
  - 線幅: 2px
  - 塗りつぶし: 透明
  
- **点フィーチャー**
  - 円形マーカー（半径6px）
  - 塗りつぶし色: オレンジ (#ff7800)
  - 境界線: 黒 (1px)

- **属性情報**
  - `properties.name`がある場合、ポップアップで表示

## ユーザーインターフェース

### 1. レイアウト構成
- **地図表示領域**: 全画面表示
- **コントロールパネル**: 画面右上に縦配置
- **要素間隙間**: 10px

### 2. コントロール要素

#### 2.1 数値入力コントロール
- **表示倍率入力**: ラベル付き数値フィールド
- **透過度入力**: ラベル付き数値フィールド（0-100%）

#### 2.2 座標表示コントロール
- **北緯表示**: 読み取り専用テキストフィールド（小数点6桁）
- **東経表示**: 読み取り専用テキストフィールド（小数点6桁）

#### 2.3 操作ボタン
- **中心座標ボタン**: トグル式、アクティブ時は背景色変更
- **画像読込ボタン**: ファイル選択ダイアログ起動
- **GPS値読込ボタン**: Excelファイル選択ダイアログ起動
- **GeoJSON読込ボタン**: GeoJSONファイル選択ダイアログ起動

### 3. 視覚効果・アニメーション
- **ハンドル強調**: ホバー時の拡大・色変更・シャドウ効果
- **カーソル変更**: 操作に応じた適切なカーソル表示
- **トランジション**: 0.2秒のスムーズなアニメーション

## データ処理仕様

### 1. 座標系
- **使用座標系**: WGS84（世界測地系）
- **座標形式**: 10進数度（Decimal Degrees）
- **精度**: 小数点6桁まで表示

### 2. ファイル処理
- **同期処理**: FileReader APIによる非同期ファイル読み込み
- **メモリ管理**: 画像データのオブジェクト再利用
- **エラー回復**: ファイル選択リセットによる再試行可能

### 3. 状態管理
- **グローバル状態変数**
  - `imageOverlay`: 現在表示中の画像レイヤー
  - `currentImage`: 読み込み済み画像オブジェクト
  - `centerMarker`: 中心位置マーカー
  - `dragHandles`: リサイズハンドル配列
  - `isDragging`, `isMovingImage`, `isCenteringMode`: 操作状態フラグ

## 制約・限界

### 1. ブラウザ要件
- **必須API**: FileReader API、DOM API
- **推奨ブラウザ**: モダンブラウザ（Chrome、Firefox、Safari、Edge）
- **非対応**: Internet Explorer 11以前

### 2. ファイル制約
- **画像ファイル**: PNG形式のみ対応
- **Excelファイル**: .xlsx形式のみ、特定の列構成が必要
- **ファイルサイズ**: ブラウザメモリ制限に依存

### 3. 機能制限
- **サーバーサイド処理**: なし（完全クライアントサイド）
- **データ永続化**: なし（リロード時にデータ消失）
- **座標変換**: 日本国内の座標系のみを想定

## エラーハンドリング

### 1. ファイル関連エラー
- **無効画像ファイル**: カスタムモーダルで通知
- **破損画像ファイル**: 読み込み失敗時に通知
- **Excel列不足**: コンソールエラー出力
- **GeoJSON形式エラー**: カスタムモーダルで通知

### 2. 操作関連エラー
- **無効座標値**: 自動スキップ処理
- **ゼロ除算**: 最小値制限による回避
- **メモリ不足**: ブラウザ標準エラー処理に委任

### 3. ユーザビリティ対応
- **同一ファイル再選択**: input要素のvalue自動リセット
- **操作中断**: マウス離脱・ウィンドウフォーカス喪失時の状態リセット
- **カーソル復旧**: 操作終了時の強制的なカーソルリセット

## 性能仕様

### 1. レスポンシブ性
- **リアルタイム更新**: 透過度・位置・サイズ変更の即座反映
- **スムーズ操作**: 60FPSを目標とするドラッグ操作

### 2. メモリ使用量
- **画像キャッシュ**: 1つの画像オブジェクト再利用
- **マーカー管理**: 動的生成・削除による最適化

### 3. 描画最適化
- **レイヤー分離**: ドラッグハンドル専用ペイン（z-index: 650）
- **中心マーカー専用ペイン**: 最上位表示（z-index: 700）

---

*作成日: 2025年8月10日*  
*バージョン: 1.0*