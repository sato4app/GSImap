# 機能仕様書 - 国土地理院 地形図ビューア

## 1. 概要

本アプリケーションは、国土地理院の提供する地図を背景に、ユーザーが任意のPNG画像をオーバーレイ表示し、そのサイズと透過度をUIから調整できるWebアプリケーションである。

## 2. 機能一覧

- **地図表示機能**
  - 特定の初期地点（箕面大滝）を中心とした国土地理院の地図を表示する。
  - 初期地点にマーカーを表示する。
- **中心座標の表示と設定機能**
- **画像オーバーレイ機能**
  - ローカルからPNG画像を読み込む。
  - 読み込んだ画像を地図の中心に重ねて表示する。
  - 画像の表示倍率と透過度をUIから調整できる。
- **GPSデータ読み込み機能**
  - ローカルからCSVファイルを読み込む。
  - CSVファイルに含まれる複数の地点情報（名称、緯度、経度）をマーカーとして地図上に表示する。

## 3. 詳細仕様

### 3.1. 地図表示機能

#### 3.1.1. 初期表示

- **初期中心座標**: 箕面大滝 (緯度: 34.853667, 経度: 135.472041)
- **初期ズームレベル**: 15

#### 3.1.2. 地図タイル

- **使用タイル**: 国土地理院 標準地図 (`https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png`)
- **帰属表示**: 地図右下に「地理院タイル」のクレジットと、国土地理院のWebサイトへのリンクを表示する。

#### 3.1.3. マーカー

- アプリケーションの起動時に、初期中心座標（箕面大滝）にマーカーが設置される。
- このマーカーは、「中心座標」ボタンを使用して地図上をクリックすることで、任意の位置に再設置できる。
- マーカーの位置座標（緯度・経度）は、UI上の「北緯」「東経」テキストボックスに表示される。

### 3.2. 画像オーバーレイ機能

#### 3.2.1. UIコンポーネント

画面右上に以下の操作コントロールを配置する。

- **表示倍率コントロール**
  - `表示倍率` というラベルを持つ数値入力欄。
  - **初期値**: 0.3
  - **入力範囲**: 0.1以上
  - **機能**: 地図の表示領域の幅に対する画像の幅の比率を指定する。値が変更されると、即座に画像のサイズが更新される。

- **透過度コントロール**
  - `透過度(%)` というラベルを持つ数値入力欄。
  - **初期値**: 50
  - **入力範囲**: 0 から 100
  - **機能**: オーバーレイ画像の不透明度をパーセントで指定する（0%で完全透明、100%で完全不透明）。値が変更されると、即座に画像の透過度が更新される。

- **中心座標ボタン**
  - `[中心座標]` というラベルのボタン。
  - クリックすると「中心座標設定モード」になり、ボタンがアクティブ（押し込み）状態に変わる。
  - このモード中に地図上をクリックすると、その位置にマーカーが設置され、地図の中心が移動し、モードは自動的に解除される。

- **北緯・東経表示欄**
  - `北緯` と `東経` のラベルを持つ読み取り専用のテキストボックス。
  - 地図上のマーカーの緯度と経度を小数点以下6桁で表示する。
  - アプリケーション起動時、およびマーカーが更新されるたびに、表示値は自動的に更新される。

- **画像読込ボタン**
  - `[画像読込]` というラベルのボタン。
  - クリックすると、ファイル選択ダイアログが開く。
  - 選択可能なファイル形式はPNG画像 (`image/png`) のみ。
- **GPS読込ボタン**
  - `[GPS読込]` というラベルのボタン。
  - `[画像読込]` ボタンの下に配置する。
  - クリックすると、ファイル選択ダイアログが開く。
  - 選択可能なファイル形式はCSVファイル (`text/csv`) のみ。

#### 3.2.2. 画像読み込み

- ユーザーがファイル選択ダイアログでPNGファイルを選択すると、`FileReader` API を使用して画像を読み込む。
- 読み込みが完了すると、`Image` オブジェクトの `onload` イベントが発火し、画像表示処理 (`updateImageDisplay`) が実行される。
- 一度ファイルを選択した後でも、同じファイルを再度選択して読み込み直すことが可能。

#### 3.2.3. 画像表示

- 読み込まれた画像は、`L.imageOverlay` を使用して、現在の地図表示の中心に配置される。
- 画像のサイズは、「表示倍率」コントロールの値と地図の表示幅に基づいて計算される。
- 画像の縦横比は常に維持される。
- 既に別の画像が表示されている場合、古い画像は地図から削除され、新しい画像に置き換わる。

#### 3.2.4. 画像操作

- **UIによる操作**:
  - **サイズ変更**: 「表示倍率」コントロールの値を変更すると、画像のサイズが即座に更新される。
  - **透過度変更**: 「透過度」コントロールの値を変更すると、画像の透過度が即座に更新される。
- **マウス操作**:
  - マウスによる画像の直接的な移動、リサイズ、回転、変形はできない。


#### 3.2.5. エラー処理

- **無効な画像**: 読み込んだファイルのサイズが0など、有効な画像として認識できない場合、「有効な画像ファイルではありません。別のファイルを選択してください。」というメッセージボックスを表示する。
- **読み込み失敗**: ファイルが破損しているなどの理由で画像の読み込みに失敗した場合、「画像の読み込みに失敗しました。ファイルが破損している可能性があります。」というメッセージボックスを表示する。

## 4. 技術仕様
### 3.3. GPSデータ読み込み機能

#### 3.3.1. UIコンポーネント

- **GPS読込ボタン**
  - `[GPS読込]` というラベルのボタン。
  - クリックするとファイル選択ダイアログが開き、ユーザーはCSVファイルを選択できる。

#### 3.3.2. CSVファイル形式

- **フォーマット**: 1行に1地点の情報をカンマ区切りで記述する。
- **列の順序**: `名称`, `緯度`, `経度`
- **ヘッダー行**: なし。
- **文字コード**: UTF-8
- **例**:
  ```csv
  箕面駅,34.8323,135.4711
  勝尾寺,34.8694,135.4947
  ```

#### 3.3.3. データ読み込みとマーカー設置

- `FileReader` API を使用して、選択されたCSVファイルをテキストとして読み込む。
- 読み込み完了後、テキストを行ごとに分割し、各行をカンマで分割して地点情報（名称, 緯度, 経度）を取得する。
- 各地点情報に基づいて `L.marker` を作成し、地図上に追加する。
- マーカーには、クリックするとその地点の「名称」がポップアップで表示されるように設定する。
- 新しいCSVファイルが読み込まれた場合、以前にCSVから読み込んで表示されていたマーカーはすべて削除してから、新しいマーカーを設置する。（※初期表示のマーカーや中心座標設定用のマーカーは対象外）

#### 3.3.4. エラー処理

- **フォーマットエラー**: CSVの行が3つの要素（名称, 緯度, 経度）で構成されていない場合や、緯度・経度が数値として解釈できない場合は、その行をスキップし、処理を続行する。
- **読み込み失敗**: すべての行がエラーでマーカーを一つも設置できなかった場合、「有効な地点情報が含まれていません。CSVファイルのフォーマットを確認してください。」というメッセージボックスを表示する。

## 4. 技術仕様

- **主要ライブラリ**:
  - Leaflet.js (v1.9.4): 地図表示と画像オーバーレイのコアライブラリ。
- **主要API**:
  - FileReader API: ローカルの画像ファイルを読み込むために使用。
- **スクリプト実行**:
  - HTML内の`<script>`タグに`defer`属性を付与し、HTMLの解析をブロックすることなくスクリプトを読み込む。
  - `window.addEventListener('load', ...)` を利用して、すべてのページリソースが完全に読み込まれた後に画像関連機能を初期化する。
  - FileReader API: ローカルの画像ファイルやCSVファイルを読み込むために使用。
- **スクリプト実行**:
  - HTML内の`<script>`タグに`defer`属性を付与し、HTMLの解析をブロックすることなくスクリプトを読み込む。
  - `window.addEventListener('load', ...)` を利用して、すべてのページリソースが完全に読み込まれた後に関数を初期化する。